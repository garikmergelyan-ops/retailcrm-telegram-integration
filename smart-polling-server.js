const express = require('express');
const axios = require('axios');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3001;

// Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸
const serverId = Math.random().toString(36).substring(2, 15);
console.log(`ğŸ†” Server started with ID: ${serverId}`);

// ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ñ… Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ² RetailCRM
const retailCRMAccounts = [
    {
        name: 'Account 1 (Ghana)',
        url: process.env.RETAILCRM_URL_1 || process.env.RETAILCRM_URL,
        apiKey: process.env.RETAILCRM_API_KEY_1 || process.env.RETAILCRM_API_KEY,
        telegramChannel: process.env.TELEGRAM_CHANNEL_ID_1 || process.env.TELEGRAM_CHANNEL_ID,
        currency: process.env.CURRENCY_1 || process.env.CURRENCY || 'GHS'
    },
    {
        name: 'Account 2',
        url: process.env.RETAILCRM_URL_2,
        apiKey: process.env.RETAILCRM_API_KEY_2,
        telegramChannel: process.env.TELEGRAM_CHANNEL_ID_2,
        currency: process.env.CURRENCY_2 || 'USD'
    }
    // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ²
].filter(account => account.url && account.apiKey); // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ñ‹

console.log(`ğŸš€ Configured ${retailCRMAccounts.length} RetailCRM account(s)`);
retailCRMAccounts.forEach((account, index) => {
    console.log(`  ${index + 1}. ${account.name}: ${account.url}`);
});

// Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²
const orderStatuses = new Map(); // orderId -> { status, lastUpdate }

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Telegram
async function sendTelegramMessage(message, channelId = null) {
    try {
        const botToken = process.env.TELEGRAM_BOT_TOKEN;
        const targetChannel = channelId || process.env.TELEGRAM_CHANNEL_ID;
        
        if (!botToken || !targetChannel) {
            console.error('Missing Telegram settings');
            return false;
        }

        const response = await axios.post(`https://api.telegram.org/bot${botToken}/sendMessage`, {
            chat_id: targetChannel,
            text: message,
            parse_mode: 'HTML'
        });

        console.log(`âœ… Message sent to Telegram channel: ${targetChannel}`);
        return true;
    } catch (error) {
        console.error('âŒ Error sending to Telegram:', error.message);
        return false;
    }
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ¸Ğ· RetailCRM
async function getOrdersFromRetailCRM() {
    try {
        let allOrders = [];
        
        // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹ Ğ¸Ğ· Ğ²ÑĞµÑ… Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ñ… Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ²
        for (const account of retailCRMAccounts) {
            try {
                console.log(`ğŸ” Checking orders from ${account.name}...`);
                
                const response = await axios.get(`${account.url}/api/v5/orders`, {
                    params: { 
                        apiKey: account.apiKey,
                        limit: 100
                    }
                });

                if (response.data.success && response.data.orders) {
                    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğµ Ğº ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼Ñƒ Ğ·Ğ°ĞºĞ°Ğ·Ñƒ
                    const ordersWithAccount = response.data.orders.map(order => ({
                        ...order,
                        accountName: account.name,
                        accountUrl: account.url,
                        accountCurrency: account.currency,
                        telegramChannel: account.telegramChannel
                    }));
                    
                    allOrders = allOrders.concat(ordersWithAccount);
                    console.log(`âœ… Got ${response.data.orders.length} orders from ${account.name}`);
                } else {
                    console.error(`âŒ Error getting orders from ${account.name}:`, response.data.errorMsg);
                }
            } catch (error) {
                console.error(`âŒ Error with ${account.name}:`, error.message);
            }
        }
        
        return allOrders;
    } catch (error) {
        console.error('RetailCRM API error:', error.message);
        return [];
    }
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ± Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğµ Ğ¿Ğ¾ ID
async function getManagerInfo(managerId) {
    try {
        const retailcrmUrl = process.env.RETAILCRM_URL;
        const apiKey = process.env.RETAILCRM_API_KEY;
        
        if (!retailcrmUrl || !apiKey || !managerId) {
            return null;
        }

        const response = await axios.get(`${retailcrmUrl}/api/v5/users/${managerId}`, {
            params: { apiKey }
        });

        if (response.data.success) {
            return response.data.user;
        } else {
            console.error('Error getting operator information:', response.data.errorMsg);
            return null;
        }
    } catch (error) {
        console.error('API error getting operator:', error.message);
        return null;
    }
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğµ
async function formatOrderMessage(order) {
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğµ
    let managerName = 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½';
    if (order.managerId) {
        const manager = await getManagerInfo(order.managerId);
        if (manager) {
            managerName = manager.firstName && manager.lastName ? 
                `${manager.firstName} ${manager.lastName}` : 
                manager.firstName || manager.lastName || `ID: ${order.managerId}`;
        } else {
            managerName = `ID: ${order.managerId}`;
        }
    }

    const items = order.items || [];
    const itemsText = items.map(item => {
        const productName = item.offer?.displayName || item.offer?.name || 'Product';
        const quantity = item.quantity || 1;
        return `â€¢ ${productName} - ${quantity} pcs`;
    }).join('\n');

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞµ
    const deliveryAddress = order.delivery?.address;
    const addressText = deliveryAddress ? 
        `${deliveryAddress.street || ''} ${deliveryAddress.building || ''} ${deliveryAddress.apartment || ''}`.trim() || 
        deliveryAddress.text || 
        'Not specified' : 'Not specified';
    
    const city = deliveryAddress?.city || order.delivery?.city || 'Not specified';
    const deliveryDate = order.delivery?.date || order.deliveryDate || 'Not specified';
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½
    const additionalPhone = order.additionalPhone || 
                           (order.contact?.phones && order.contact.phones.length > 1 ? 
                            order.contact.phones[1].number : 'Not specified');

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾ Ğ“Ğ°Ğ½Ğµ (GMT+0)
    const ghanaTime = new Date().toLocaleString('en-GB', {
        timeZone: 'Africa/Accra',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });

    return `ğŸ›’ <b>NEW ORDER APPROVED!</b>

ğŸ“‹ <b>Order Number:</b> ${order.number || order.id}
ğŸ‘¤ <b>Operator:</b> ${managerName}
ğŸ“… <b>Delivery Date:</b> ${deliveryDate}
ğŸ‘¨â€ğŸ’¼ <b>Customer Name:</b> ${order.firstName || ''} ${order.lastName || ''}
ğŸ“± <b>Phone:</b> ${order.phone || 'Not specified'}
ğŸ“± <b>Additional Phone:</b> ${additionalPhone}
ğŸ“ <b>Delivery Address:</b> ${addressText}
ğŸ™ï¸ <b>City:</b> ${city}

ğŸ›ï¸ <b>Products:</b>
${itemsText}

ğŸ’° <b>Order Total:</b> ${order.totalSumm || 0} ${process.env.CURRENCY || 'GHS'}

â° <b>Approval Time:</b> ${ghanaTime} (Ghana Time)`;
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²
async function checkOrderStatusChanges() {
    try {
        console.log(`ğŸ” [${serverId}] Checking orders... (tracked: ${orderStatuses.size})`);
        
        const orders = await getOrdersFromRetailCRM();
        let newApprovalsCount = 0;
        let isFirstRun = orderStatuses.size === 0; // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ»Ğ¸ ÑÑ‚Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞº
        
        if (isFirstRun) {
            console.log('ğŸš€ First run - checking all approved orders...');
        }
        
        for (const order of orders) {
            const orderId = order.id;
            const currentStatus = order.status;
            const currentUpdate = order.updatedAt || order.dateCreate;
            
            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
            const previousData = orderStatuses.get(orderId);
            
            if (!previousData) {
                // ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ñ€Ğ°Ğ· Ğ²Ğ¸Ğ´Ğ¸Ğ¼ ÑÑ‚Ğ¾Ñ‚ Ğ·Ğ°ĞºĞ°Ğ·
                orderStatuses.set(orderId, {
                    status: currentStatus,
                    lastUpdate: currentUpdate
                });
                
                // Ğ•ÑĞ»Ğ¸ Ğ·Ğ°ĞºĞ°Ğ· ÑƒĞ¶Ğµ approved, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ½Ğ¾ Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ)
                if (currentStatus === 'approved') {
                    if (isFirstRun) {
                        console.log(`âœ… Order ${order.number || orderId} is already approved - added to tracking (first run)`);
                    } else {
                        console.log(`ğŸ†• New approved order ${order.number || orderId} found!`);
                        const message = await formatOrderMessage(order);
                        await sendTelegramMessage(message, order.telegramChannel);
                        newApprovalsCount++;
                    }
                }
            } else {
                // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ Ğ»Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑ
                if (previousData.status !== currentStatus) {
                    console.log(`ğŸ”„ Order ${order.number || orderId} status changed: ${previousData.status} â†’ ${currentStatus}`);
                    
                    // Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ Ğ½Ğ° approved, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
                    if (currentStatus === 'approved') {
                        console.log(`ğŸ†• Order ${order.number || orderId} was just approved!`);
                        
                        const message = await formatOrderMessage(order);
                        await sendTelegramMessage(message, order.telegramChannel);
                        newApprovalsCount++;
                    }
                    
                    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğµ
                    orderStatuses.set(orderId, {
                        status: currentStatus,
                        lastUpdate: currentUpdate
                    });
                }
                // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ½Ñ‹Ñ… ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² Ğ´Ğ»Ñ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
            }
        }
        
        if (isFirstRun) {
            console.log(`ğŸ¯ First run completed. Found ${orderStatuses.size} orders to track.`);
        } else if (newApprovalsCount > 0) {
            console.log(`âœ… Sent ${newApprovalsCount} approval notification(s)`);
        }
        // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸Ğ·Ğ±Ñ‹Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ´Ğ»Ñ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
        
    } catch (error) {
        console.error('âŒ Error checking orders:', error.message);
    }
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ²ÑĞµÑ… approved Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ
async function checkAllApprovedOrdersOnStartup() {
    try {
        console.log('ğŸš€ Starting full check of all approved orders...');
        
        const orders = await getOrdersFromRetailCRM();
        let approvedOrdersFound = 0;
        
        for (const order of orders) {
            if (order.status === 'approved') {
                const orderId = order.id;
                const previousData = orderStatuses.get(orderId);
                
                if (!previousData) {
                    // ĞĞ¾Ğ²Ñ‹Ğ¹ approved Ğ·Ğ°ĞºĞ°Ğ· - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ
                    orderStatuses.set(orderId, {
                        status: 'approved',
                        lastUpdate: order.updatedAt || order.dateCreate
                    });
                    
                    console.log(`âœ… Found approved order ${order.number || orderId} - added to tracking`);
                    approvedOrdersFound++;
                } else if (previousData.status !== 'approved') {
                    // Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ Ğ½Ğ° approved - Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
                    console.log(`ğŸ†• Order ${order.number || orderId} status changed to approved!`);
                    
                    const message = await formatOrderMessage(order);
                    await sendTelegramMessage(message, order.telegramChannel);
                    
                    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
                    orderStatuses.set(orderId, {
                        status: 'approved',
                        lastUpdate: order.updatedAt || order.dateCreate
                    });
                    
                    approvedOrdersFound++;
                }
            }
        }
        
        console.log(`ğŸ¯ Found ${approvedOrdersFound} approved orders on startup`);
        
    } catch (error) {
        console.error('âŒ Error checking approved orders on startup:', error.message);
    }
}

// Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºÑƒÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 30 ÑĞµĞºÑƒĞ½Ğ´
setInterval(checkOrderStatusChanges, 30000);

// Health check endpoint Ğ´Ğ»Ñ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ "spin down" Ğ½Ğ° Render
app.get('/health', (req, res) => {
    res.json({ 
        status: 'healthy',
        timestamp: new Date().toISOString(),
        uptime: process.uptime(),
        accounts: retailCRMAccounts.length
    });
});

// ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿Ğ¸Ğ½Ğ³ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ´Ğ»Ñ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ "spin down"
setInterval(async () => {
    try {
        const response = await axios.get(`${process.env.RENDER_EXTERNAL_URL || 'http://localhost:3000'}/health`);
        console.log('ğŸ’“ Health check ping sent to prevent spin down');
    } catch (error) {
        console.log('ğŸ’“ Health check ping sent (local)');
    }
}, 10 * 60 * 1000); // ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚

// Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ endpoint
app.get('/test', (req, res) => {
    res.json({ 
        message: 'Smart Polling server is working!',
        timestamp: new Date().toISOString(),
        trackedOrders: orderStatuses.size
    });
});

// Endpoint Ğ´Ğ»Ñ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
app.get('/check-orders', async (req, res) => {
    await checkOrderStatusChanges();
    res.json({ 
        message: 'Status change check completed',
        timestamp: new Date().toISOString()
    });
});

// Endpoint Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²
app.get('/orders-status', (req, res) => {
    const ordersList = Array.from(orderStatuses.entries()).map(([id, data]) => ({
        orderId: id,
        status: data.status,
        lastUpdate: data.lastUpdate
    }));
    
    res.json({
        trackedOrders: orderStatuses.size,
        orders: ordersList
    });
});

// Endpoint Ğ´Ğ»Ñ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ²ÑĞµÑ… approved Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²
app.get('/check-all-approved', async (req, res) => {
    try {
        await checkAllApprovedOrdersOnStartup();
        res.json({ 
            message: 'Full approved orders check completed',
            timestamp: new Date().toISOString(),
            trackedOrders: orderStatuses.size
        });
    } catch (error) {
        res.status(500).json({ 
            error: 'Error checking approved orders',
            message: error.message
        });
    }
});

// Endpoint Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ° Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
app.get('/reset-memory', (req, res) => {
    const previousCount = orderStatuses.size;
    orderStatuses.clear();
    
    res.json({
        message: 'Server memory reset',
        previousTrackedOrders: previousCount,
        currentTrackedOrders: 0,
        timestamp: new Date().toISOString()
    });
    
    console.log(`ğŸ§¹ Server memory reset. Previous tracked orders: ${previousCount}`);
});

// Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
app.listen(PORT, () => {
    console.log(`ğŸš€ Smart Polling server started on port ${PORT}`);
    console.log(`ğŸ§ª Test: http://localhost:${PORT}/test`);
    console.log(`ğŸ” Check orders: http://localhost:${PORT}/check-orders`);
    console.log(`ğŸ“Š Order statuses: http://localhost:${PORT}/orders-status`);
    console.log(`â° Checking every 30 seconds`);
    
    // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ²ÑƒÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ ÑÑ€Ğ°Ğ·Ñƒ
    checkOrderStatusChanges();
});

module.exports = app;
