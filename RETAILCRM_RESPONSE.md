# Ответ на сообщение поддержки RetailCRM

Добрый день!

Спасибо за ваш ответ, однако он поднимает больше вопросов, чем дает ответов. Разрешите уточнить несколько моментов.

 1. Запросы "не доходят до CRM"

Вы указали, что проблемные запросы вовсе не доходят до CRM. Это критически важная информация, которая указывает на проблему на уровне:

- Сетевой инфраструктуры (между нашим сервером и вашими серверами)
- Маршрутизации/DNS
- Firewall/прокси-серверов на стороне RetailCRM
- Балансировщиков нагрузки, которые могут блокировать или терять запросы
- Rate limiting на уровне инфраструктуры (до достижения вашего API)

Вопрос: Если запросы не доходят до CRM, то где именно они теряются? Просим проверить:
- Логи на балансировщиках нагрузки
- Логи на прокси-серверах/API Gateway
- Настройки firewall
- Возможные блокировки по IP-адресам

 2. Несоответствие в упомянутом запросе

Вы упомянули запрос на время 12:46:05:
```
/orders/?filter[productSearchType]=or&filter[extendedStatus]=41&filter[direction]=asc
```

Это НЕ наш запрос. Наша интеграция делает запросы к API v5:
```
GET /api/v5/orders?apiKey=...&limit=50&page=1
```

Вопрос: Возможно, вы смотрите логи веб-интерфейса RetailCRM, а не логи API? Просим проверить логи именно для эндпоинта `/api/v5/orders` с параметрами `limit` и `page`, а не для веб-интерфейса.

 3. Что мы реально делаем

Наши запросы:
- Эндпоинт: `GET /api/v5/orders`
- Параметры:
  - `apiKey` (наш API ключ)
  - `limit=50` (50 заказов на страницу)
  - `page=1`, `page=2`, ..., `page=20` (пагинация)
- Метод: GET через HTTPS
- Headers:
  - `Connection: keep-alive`
  - `Accept: application/json`
  - `User-Agent: RetailCRM-Integration/1.0`
  - `Accept-Encoding: gzip, deflate`
- Таймаут: 120 секунд (120000ms)
- Частота: 1 раз в 10 минут (6 запросов в час на аккаунт)

4. Проблема не решена

Вы упомянули, что "ближайшие по времени запросы получали статус 200 и время ожидания не превышало 300мс". Это означает, что:

1. Либо вы смотрите на другие запросы (не наши)
2. Либо проблема проявляется нестабильно (что мы и наблюдаем - иногда работает, иногда нет)
3. Либо есть проблема с логированием на вашей стороне

Конкретные вопросы для решения проблемы

 Вопрос 1: Логирование запросов
Просим предоставить логи для наших конкретных запросов на указанное время:
- 12:39:20 - запрос к `aff-gh.retailcrm.ru/api/v5/orders?apiKey=...&limit=50&page=1`
- 12:44:47 - запрос к `slimteapro-store.retailcrm.ru/api/v5/orders?apiKey=...&limit=50&page=1`

С параметрами именно для эндпоинта `/api/v5/orders`, а не для веб-интерфейса.

 Вопрос 2: Сетевая инфраструктура
Если запросы не доходят до CRM, где именно они теряются?
- Есть ли у вас мониторинг на уровне балансировщиков?
- Есть ли логи на API Gateway?
- Есть ли блокировки по IP-адресам наших серверов?
- Какие IP-адреса мы должны использовать для whitelist (если требуется)?

Наше окружение: Render.com (облачный хостинг), IP-адреса могут меняться динамически.

 Вопрос 3: Стабильность работы
Вы упомянули, что запросы получают статус 200 за 300мс. Но мы наблюдаем нестабильность:
- Иногда запросы проходят успешно за 1-3 секунды
- Иногда все запросы timeout (120+ секунд без ответа)
- Проблема проявляется непостоянно, но регулярно

 Вопрос: Есть ли на вашей стороне:
- Периодические нагрузки на серверах?
- Плановые работы, которые могут вызывать задержки?
- Очереди запросов, которые могут блокировать наши запросы?
- Проблемы с конкретными аккаунтами или серверами?

 Вопрос 4: Альтернативные решения
Если проблема на уровне сетевой инфраструктуры, какие есть альтернативы:
- Можно ли использовать другой регион серверов?
- Есть ли альтернативные эндпоинты для получения заказов?
- Можно ли использовать webhooks вместо polling?

 Вопрос 5: Диагностика
Как мы можем помочь вам в диагностике?
- Нужны ли логи с нашего сервера с полными заголовками запросов?
- Нужны ли сетевые трассировки (traceroute)?
- Можем ли мы предоставить дополнительные данные для анализа?

Что мы ожидаем

1. Конкретный ответ на вопрос: Почему запросы к `/api/v5/orders` timeout на уровне 120 секунд, если они даже не доходят до вашего API?

2. Проверку именно наших запросов: Логи для эндпоинта `/api/v5/orders` с нашими параметрами (`limit=50`, `page=1-20`), а не для веб-интерфейса.

3. Решение проблемы: Либо диагностика и исправление сетевой проблемы, либо рекомендации по обходу проблемы (альтернативные эндпоинты, настройки, регионы).


Ваш ответ указывает на то, что проблема находится на уровне сетевой инфраструктуры между нашим сервером и вашими API-серверами. Это критическая проблема, которая не позволяет нам использовать ваш API стабильно.

Мы готовы предоставить любую дополнительную информацию для диагностики и решения проблемы. Просим не закрывать тикет до полного решения вопроса.





Пример наших запросов

Для справки, вот пример реального запроса, который мы делаем:

```
GET https://aff-gh.retailcrm.ru/api/v5/orders?apiKey=XXXXX&limit=50&page=1
Headers:
  Connection: keep-alive
  Accept: application/json
  User-Agent: RetailCRM-Integration/1.0
  Accept-Encoding: gzip, deflate
Timeout: 120000ms
```

Этот запрос иногда успешно выполняется за 1-3 секунды, а иногда timeout через 120 секунд без какого-либо ответа от сервера.

